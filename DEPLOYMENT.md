# HSPT Vocabulary App - Deployment Guide

Complete guide for deploying this Node.js/Express app to Render with PostgreSQL.

## ğŸ“‹ Prerequisites

- Git/GitHub account
- Render account (free): https://render.com
- Either:
  - **Option A**: Render Postgres (free, 90-day limit)
  - **Option B**: Supabase Postgres (free, persistent but auto-pauses after 7 days)

---

## ğŸ—ï¸ Project Structure

```
vocab/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ index.js              # Entry point
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ db.js             # Database connection (supports DATABASE_URL)
â”‚   â”œâ”€â”€ models/               # Sequelize models
â”‚   â”œâ”€â”€ routes/               # API routes
â”‚   â”œâ”€â”€ middleware/           # Auth & error handling
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ initDb.js         # Database migration
â”‚   â”‚   â”œâ”€â”€ importVocab.js    # Import vocabulary data
â”‚   â”‚   â””â”€â”€ createAdmin.js    # Create admin user
â”‚   â””â”€â”€ utils/                # Helper functions
â”œâ”€â”€ client/public/            # Frontend static files
â”œâ”€â”€ Dockerfile                # Container configuration
â”œâ”€â”€ render.yaml               # Render deployment config
â”œâ”€â”€ package.json              # Dependencies & scripts
â””â”€â”€ .env.example              # Environment variables template
```

---

## ğŸš€ Deployment Options

### Option A: Render Postgres (Recommended for Testing)

**Pros**: Fully integrated, automatic setup
**Cons**: Free tier expires after 90 days

**Setup Steps**:

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Deploy to Render**
   - Go to https://dashboard.render.com
   - Click **"New +"** â†’ **"Blueprint"**
   - Connect your GitHub repository
   - Select the repo with `render.yaml`
   - Click **"Apply"**
   - Render will:
     - Create Postgres database
     - Create web service
     - Auto-configure DATABASE_URL
     - Deploy your app

3. **Configure Environment Variables**
   
   After deployment, go to your web service â†’ **Environment**:
   ```
   NODE_ENV=production
   PORT=3000
   SESSION_SECRET=<auto-generated>
   DATABASE_URL=<auto-configured from DB>
   ADMIN_EMAIL=admin@yourdomain.edu
   ADMIN_PASSWORD=YourSecurePassword123!
   ```

4. **Initialize Database**
   
   After first deploy, Render automatically runs `npm run migrate` via `postinstall` script.
   
   To manually run admin creation:
   - Go to your web service â†’ **Shell**
   - Run: `npm run create-admin`

5. **Access Your App**
   - Your app URL: `https://hspt-vocab-app.onrender.com`
   - First request may take 30-60 seconds (cold start)

---

### Option B: Supabase Postgres (Longer-term Free)

**Pros**: Persistent database, doesn't expire
**Cons**: Auto-pauses after 7 days inactivity (15-20s wake time)

**Setup Steps**:

1. **Create Supabase Database**
   - Go to https://supabase.com
   - Create new project
   - Choose region close to Render (e.g., US West for Oregon)
   - âš ï¸ Save the database password!

2. **Get Connection String**
   - Go to **Project Settings** â†’ **Database**
   - Copy **Connection string** (Session mode recommended)
   - Format: `postgres://postgres.[project-ref]:[password]@aws-0-us-west-1.pooler.supabase.com:5432/postgres`

3. **Deploy to Render**
   
   **Method 1: Use Render dashboard**
   - Go to https://dashboard.render.com
   - Click **"New +"** â†’ **"Web Service"**
   - Connect GitHub repo
   - Configure:
     - **Name**: `hspt-vocab-app`
     - **Region**: Oregon (or nearest to Supabase)
     - **Branch**: `main`
     - **Build Command**: `npm install`
     - **Start Command**: `npm start`
     - **Instance Type**: Free
   
   **Method 2: Modify render.yaml**
   - Remove the `databases:` section
   - Add DATABASE_URL as static env var:
     ```yaml
     envVars:
       - key: DATABASE_URL
         value: postgres://postgres.[project-ref]:[password]@...
     ```
   - Push changes and deploy via Blueprint

4. **Configure Environment Variables**
   ```
   NODE_ENV=production
   PORT=3000
   SESSION_SECRET=<generate secure random string>
   DATABASE_URL=<your Supabase connection string>
   ADMIN_EMAIL=admin@yourdomain.edu
   ADMIN_PASSWORD=YourSecurePassword123!
   ```

5. **Initialize Database**
   - In Render Shell: `npm run migrate`
   - Create admin: `npm run create-admin`

---

## ğŸ”§ Local Development

1. **Clone & Install**
   ```bash
   git clone <your-repo-url>
   cd vocab
   npm install
   ```

2. **Setup Local Database**
   ```bash
   # Install Postgres (macOS)
   brew install postgresql@14
   brew services start postgresql@14
   
   # Create database
   createdb vocab_app
   ```

3. **Configure Environment**
   ```bash
   cp .env.example .env
   # Edit .env with your local settings
   ```

4. **Initialize Database**
   ```bash
   npm run migrate
   npm run seed
   ```

5. **Run Locally**
   ```bash
   npm run dev
   # Visit http://localhost:3000
   ```

---

## ğŸ³ Docker (Optional)

**Build & Run Locally**:
```bash
# Build image
docker build -t vocab-app .

# Run container
docker run -p 3000:3000 \
  -e NODE_ENV=production \
  -e DATABASE_URL=your_database_url \
  -e SESSION_SECRET=your_secret \
  vocab-app
```

**Docker Compose** (with local Postgres):
```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/vocab_app
      - SESSION_SECRET=local_secret
      - NODE_ENV=production
    depends_on:
      - db
  
  db:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: vocab_app
      POSTGRES_PASSWORD: password
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

Run: `docker-compose up`

---

## ğŸ“Š Monitoring & Maintenance

### View Logs
- **Render Dashboard** â†’ Your service â†’ **Logs**
- Real-time streaming during deploys and runtime

### Health Check
```bash
curl https://hspt-vocab-app.onrender.com/api/health
# Response: {"status":"ok","timestamp":"2024-..."}
```

### Database Access
- **Render Postgres**: Dashboard â†’ Database â†’ **Info** (connection details)
- **Supabase**: Dashboard â†’ **SQL Editor** or use Database URL with `psql`

### Backups
âš ï¸ **Important**: Render free Postgres doesn't include automated backups.

**Manual backup**:
```bash
# Export data
pg_dump $DATABASE_URL > backup.sql

# Restore
psql $DATABASE_URL < backup.sql
```

### Re-deploy
```bash
git add .
git commit -m "Update"
git push origin main
# Render auto-deploys (if enabled)
```

---

## âš¡ Free Tier Limitations

### Render Web Service (Free)
- **Memory**: 512 MB RAM
- **CPU**: Shared
- **Auto-sleep**: After 15 min inactivity
- **Cold start**: 30-60 seconds on first request
- **Bandwidth**: ~100 GB/month
- **Build minutes**: 500 min/month

### Render Postgres (Free)
- **Storage**: 1 GB
- **Expiration**: 90 days (then requires upgrade or refresh)
- **Connections**: Limited
- **No automated backups**

### Supabase Postgres (Free)
- **Storage**: 500 MB database
- **API requests**: 50,000/month
- **Egress**: 2 GB/month
- **Auto-pause**: After 7 days inactivity (15-20s wake)
- **Projects**: 2 active projects max

---

## ğŸ” Security Checklist

- [ ] Change default admin credentials
- [ ] Generate strong SESSION_SECRET (min 32 characters)
- [ ] Enable HTTPS (Render provides automatically)
- [ ] Review CORS settings in production
- [ ] Set secure cookie flags (already configured)
- [ ] Never commit `.env` file to git

---

## ğŸ› Troubleshooting

### Database Connection Errors
```
Error: could not connect to server
```
**Fix**:
1. Verify DATABASE_URL is set correctly
2. Check SSL settings in `db.js` (should be enabled for production)
3. Ensure Postgres accepts connections from Render IPs

### Session Issues
```
Error: relation "session" does not exist
```
**Fix**:
1. Run migrations: `npm run migrate`
2. Session table auto-created by connect-pg-simple if `createTableIfMissing: true`

### Cold Start Delays
**Expected behavior**: Free tier spins down after 15 min inactivity.
**Solutions**:
- Keep app warm with uptime monitoring (e.g., UptimeRobot)
- Or accept 30-60s first request delay

### Build Failures
```
Error: Cannot find module...
```
**Fix**:
1. Ensure all dependencies in `package.json`
2. Check Node version compatibility (app uses Node 18)
3. Review build logs in Render dashboard

---

## ğŸ“š Additional Resources

- [Render Node.js Deployment](https://render.com/docs/deploy-node-express-app)
- [Render Free Tier](https://render.com/docs/free)
- [Supabase Documentation](https://supabase.com/docs)
- [Sequelize Documentation](https://sequelize.org/docs/)

---

## ğŸ¯ Next Steps After Deployment

1. **Test the app**: Visit your Render URL
2. **Login**: Use admin credentials
3. **Import vocabulary**: Already seeded during deployment
4. **Monitor**: Check logs for any errors
5. **Backup**: Export database periodically (especially for Render free tier)

---

## ğŸ“ Notes

- For production use beyond 10-20 users, consider upgrading to paid tiers
- Render free Postgres expires after 90 days - plan accordingly
- Supabase free tier is better for persistent storage needs
- Both options work well for small-scale educational apps
